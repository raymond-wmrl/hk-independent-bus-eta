(this["webpackJsonphk-independent-bus-eta"]=this["webpackJsonphk-independent-bus-eta"]||[]).push([[6],{315:function(t,e,n){"use strict";n.r(e);var a=n(3),o=n(15),r=n(7),c=n(25),i=n(0),s=n(286),l=n(229),u=n(119),d=n(283),p=n(285),b=n(5),j=n(16),m=n(138),f=n(162),g=n(304),h=n.n(g),O=n(311),x=n(310),v=n(1),k=function(t,e){return t?fetch("https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=".concat(encodeURI(t)),e).then((function(t){return t.json()})).then((function(t){return t.map((function(t){var e=Object(x.a)("+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",[t.x,t.y]),n=Object(r.a)(e,2),a=n[0],o=n[1];return{address:{zh:t.addressZH,en:t.addressEN},name:{zh:t.nameZH,en:t.nameEN},lat:o,lng:a}}))})):new Promise((function(t){return t([])}))},C=function(t){var e=t.placeholder,n=void 0===e?"":e,a=t.onChange,o=t.stopList,r=t.value,c=Object(f.a)(),s=c.t,l=c.i18n,u=Object(i.useRef)(new AbortController),d=Object(i.useRef)(h()((function(t,e){var n=Object.values(o).filter((function(e){return e.name.zh.includes(t)||e.name.en.toLowerCase().includes(t.toLowerCase())})).map((function(t){return{label:"".concat(t.name[l.language]," - ").concat(s("\u8eca\u7ad9")),location:t.location}})).slice(0,10);u.current.abort(),u.current=new AbortController,k(t,{signal:u.current.signal}).then((function(t){e(n.concat(t.map((function(t){var e=t.name,n=t.address,a=t.lat,o=t.lng;return{label:[e[l.language],n[l.language]].filter((function(t){return t})).join(" - "),location:{lat:a,lng:o}}}))))}))}),200)).current;return Object(v.jsx)(y,{isClearable:!0,value:r,loadOptions:d,placeholder:n,onChange:a,classNamePrefix:"react-select"})},y=Object(b.a)(O.a)((function(t){var e=t.theme;return{".react-select__control":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),border:"none !important",borderRadius:"unset !important",borderBottom:"1px hsl(0, 0%, 80%) solid !important"},".react-select__input":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__valueContainer":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__single-value":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__option:hover":{filter:"grayscale(1) !important"},".react-select__option--is-focused":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important")},".react-select__option--is-selected":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__menu":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__meauList":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")}}})),w=n(288),I=n(282),L=n(289),_=n(273),R=n(84),N=n(137),S=function(t){var e=t.routes,n=t.idx,a=t.handleRouteClick,o=t.expanded,r=t.stopIdx,c=Object(i.useContext)(j.b).db,s=c.routeList,l=c.stopList,d=Object(f.a)(),p=d.t,b=d.i18n;return Object(v.jsxs)(T,{TransitionProps:{unmountOnExit:!0},classes:{root:F.root,expanded:F.expandedAccordion},onChange:function(){return a(n)},expanded:o,children:[Object(v.jsx)(w.a,{classes:{root:F.summaryRoot,content:F.content,expanded:F.summaryExpanded},children:Object(v.jsx)(I.a,{primary:e.map((function(t,e){var a=t.routeId,o=s[a],r=o.route,c=o.serviceType;return Object(v.jsxs)("span",{className:F.routeNo,children:[Object(v.jsx)(R.a,{routeNo:r}),parseInt(c,10)>=2&&Object(v.jsx)(u.a,{variant:"caption",className:F.specialTrip,children:p("\u7279\u5225\u73ed")})]},"search-".concat(n,"-").concat(e))})),secondary:function(t){var e=[];t.forEach((function(t){var n=t.routeId,a=t.on,o=s[n],r=o.fares,c=o.stops;e.push(l[Object.values(c).sort((function(t,e){return e.length-t.length}))[0][a]].name[b.language]+(r?" ($".concat(r[a],")"):""))}));var n=t[t.length-1],a=n.routeId,o=n.off,r=s[a].stops;return e.concat(l[Object.values(r).sort((function(t,e){return e.length-t.length}))[0][o]].name[b.language]).join(" \u2192 ")}(e)})}),Object(v.jsx)(L.a,{classes:{root:F.details},children:e.map((function(t,e){return Object(v.jsx)(N.a,{routeId:t.routeId.toUpperCase(),seq:t.on+(r?r[e]:0),containerClass:F.timerReport,showStopName:!0},"timereport-".concat(n,"-").concat(e))}))})]})},E="search-result",F={root:"".concat(E,"-root"),expandedAccordion:"".concat(E,"-expanded"),summaryRoot:"".concat(E,"-summary-root"),summaryExpanded:"".concat(E,"-summary-root-expanded"),content:"".concat(E,"-content"),details:"".concat(E,"-details"),timerReport:"".concat(E,"-timer-report"),routeNo:"".concat(E,"-route-no"),specialTrip:"".concat(E,"-special-trip")},T=Object(b.a)(_.a)((function(t){var e,n=t.theme;return e={},Object(a.a)(e,"&.".concat(F.root),Object(a.a)({border:"1px solid rgba(0, 0, 0, .125)",boxShadow:"none","&:not(:last-child)":{borderBottom:0},"&:before":{display:"none"}},"&.".concat(F.expandedAccordion),{margin:"auto"})),Object(a.a)(e,"& .".concat(F.summaryRoot),Object(a.a)({backgroundColor:"dark"===n.palette.mode?n.palette.background.default:"rgba(0, 0, 0, .03)",borderBottom:"1px solid rgba(0, 0, 0, .125)",marginBottom:-1,minHeight:44},"&.".concat(F.summaryExpanded),{minHeight:44})),Object(a.a)(e,"& .".concat(F.content),Object(a.a)({margin:"8px 0",flexDirection:"column"},"&.".concat(F.summaryExpanded),{margin:"8px 0"})),Object(a.a)(e,"& .".concat(F.details),{padding:n.spacing(2),paddingTop:n.spacing(1),paddingBottom:n.spacing(1),display:"flex"}),Object(a.a)(e,"& .".concat(F.timerReport),{width:"50%"}),Object(a.a)(e,"& .".concat(F.routeNo),{width:"50%",display:"inline-block"}),Object(a.a)(e,"& .".concat(F.specialTrip),{fontSize:"0.6rem",marginLeft:"8px"}),e})),B=n(312),z=n(295),A=n(261),M=n(262),P=n(263),H=n(296),W=n(22),q=n.n(W),U=n(136),G=n.n(U),Y=n(14),Z=function(t){var e=t.center,n=t.start,a=t.end,o=Object(B.a)();return e?o.flyTo(Object(Y.b)(e)):a&&o.fitBounds(q.a.latLngBounds(q.a.latLng(n.lat,n.lng),q.a.latLng(a.lat,a.lng))),Object(v.jsx)(v.Fragment,{})},D=function(){var t=Object(i.useContext)(j.b),e=t.geolocation;return"granted"!==t.geoPermission?null:Object(v.jsx)(z.a,{center:Object(Y.b)(e),radius:25})},J=function(t){var e=t.start;return e?Object(v.jsx)(A.a,{position:e,icon:nt({isStart:!0})}):null},$=function(t){var e=t.end;return e?Object(v.jsx)(A.a,{position:e,icon:nt({isStart:!1})}):null},K=function(t){var e=t.onClick;return Object(v.jsx)("div",{className:"leaflet-bottom leaflet-right",children:Object(v.jsx)(ct,{className:"".concat(ot.centralControlContainer," leaflet-control leaflet-bar"),onClick:e,children:Object(v.jsx)(G.a,{className:ot.centralControl})})})},Q=function(t){var e=t.route,n=e.routeId,a=e.on,o=e.off,r=t.lv,c=t.stopIdx,s=t.onMarkerClick,l=Object(i.useContext)(j.b).db,u=l.routeList,d=l.stopList,p=Object(f.a)().i18n,b=Object.values(u[n].stops).sort((function(t,e){return e.length-t.length}))[0].slice(a,o+1),m=n.split("-")[0];return Object(v.jsxs)(v.Fragment,{children:[b.map((function(t,e){return Object(v.jsx)(A.a,{position:d[t].location,icon:et({active:c===e,passed:e<c,lv:r}),alt:"".concat(e,". ").concat(m," - ").concat(d[t].name[p.language]),eventHandlers:{click:function(t){s(n,e)}}},"".concat(t,"-").concat(e))})),b.slice(1).map((function(t,e){return Object(v.jsx)(M.a,{positions:[tt(d[b[e]].location),tt(d[t].location)],color:0===r?"#FF9090":"#d0b708"},"".concat(t,"-line"))}))]})},V=function(t){var e=t.routes,n=t.start,a=t.end,o=Object(i.useContext)(j.b).db,r=o.routeList,c=o.stopList,s=[],l=[];if(!n||!a)return Object(v.jsx)(v.Fragment,{});l.push(n),(e||[]).forEach((function(t){var e=t.routeId,n=t.on,a=t.off,o=Object.values(r[e].stops).sort((function(t,e){return e.length-t.length}))[0];l.push(c[o[n]].location),l.push(c[o[a]].location)})),l.push(a||n);for(var u=0;u<l.length/2;++u)s.push([l[2*u],l[2*u+1]]);return Object(v.jsx)(v.Fragment,{children:s.map((function(t,e){return Object(v.jsx)(M.a,{positions:[tt(t[0]),tt(t[1])],color:"green"},"line-".concat(e))}))})},X=function(t){var e=t.routes,n=t.start,a=t.end,o=t.stopIdx,c=t.onMarkerClick,s=Object(i.useContext)(j.b),l=s.geolocation,u=s.geoPermission,d=s.updateGeoPermission,p=s.colorMode,b=Object(i.useState)({center:null,isFollow:!1}),m=Object(r.a)(b,2),f=m[0],g=m[1],h=f.center,O=f.isFollow,x=Object(i.useState)(null),k=Object(r.a)(x,2),C=k[0],y=k[1],w=function(t){var e=t.center,n=t.isFollow,a=void 0!==n&&n;g({center:e||C.getCenter(),isFollow:a})};return Object(i.useEffect)((function(){if(C)return C.on("dragend",w),function(){C.off("dragend",w)}}),[C]),Object(i.useEffect)((function(){O&&(l.lat===h.lat&&l.lng===h.lng||w({center:l,isFollow:!0}))}),[l]),Object(v.jsx)(rt,{className:ot.mapContainerBox,children:Object(v.jsxs)(P.a,{center:h||(n&&a?{lat:(n.lat+a.lat)/2,lng:(n.lng+a.lng)/2}:Object(Y.b)(n)),zoom:16,scrollWheelZoom:!1,className:ot.mapContainer,whenCreated:y,children:[Object(v.jsx)(Z,{center:h,start:Object(Y.b)(n),end:a}),Object(v.jsx)(H.a,{attribution:'\xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors \xa9 <a href="https://carto.com/attributions">CARTO</a>',url:"dark"===p?"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"}),(e||[]).map((function(t,e){return Object(v.jsx)(Q,{route:t,lv:e,stopIdx:o[e],onMarkerClick:c},"route-".concat(e))})),Object(v.jsx)(V,{routes:e,start:n,end:a}),Object(v.jsx)(D,{}),Object(v.jsx)(J,{start:n}),Object(v.jsx)($,{end:a}),Object(v.jsx)(K,{onClick:function(){"granted"===u?w({center:Object(Y.b)(l),isFollow:!0}):"denied"!==u&&(w({isFollow:!0}),d("opening"))}})]})})},tt=function(t){return[t.lat,t.lng]},et=function(t){var e=t.active,n=t.passed,a=t.lv;return q.a.icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(ot.marker," ").concat(e?ot.active:""," ").concat(n?ot.passed:""," lv-").concat(a)})},nt=function(t){var e=t.isStart;return q.a.icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(ot.marker," ").concat(e?"start":"end")})},at="searchMap",ot={mapContainerBox:"".concat(at,"-mapContainerBox"),mapContainer:"".concat(at,"-mapContainer"),centralControlContainer:"".concat(at,"-centralControlContainer"),centralControl:"".concat(at,"-centralControl"),marker:"".concat(at,"-marker"),active:"".concat(at,"-active"),passed:"".concat(at,"-passed")},rt=Object(b.a)(s.a)((function(t){var e,n=t.theme;return e={},Object(a.a)(e,"&.".concat(ot.mapContainerBox),{height:"30vh",filter:"dark"===n.palette.mode?"brightness(0.8)":"none"}),Object(a.a)(e,"& .".concat(ot.mapContainer),{height:"30vh"}),Object(a.a)(e,"& .".concat(ot.marker),{marginLeft:"-12px",marginTop:"-41px",width:"25px",height:"41px",zIndex:618,outline:"none",filter:"hue-rotate(130deg)","&.lv-1":{filter:"hue-rotate(210deg) brightness(1.5)"},"&.start":{filter:"hue-rotate(30deg)"},"&.end":{filter:"hue-rotate(280deg)"}}),Object(a.a)(e,"& .".concat(ot.active),{animation:"blinker 2s linear infinite"}),Object(a.a)(e,"& .".concat(ot.passed),{filter:"grayscale(100%)"}),e})),ct=Object(b.a)("div")((function(t){var e;t.theme;return e={},Object(a.a)(e,"& .".concat(ot.centralControl),{padding:"5px",color:"black"}),Object(a.a)(e,"&.".concat(ot.centralControlContainer),{background:"white",height:"28px",marginBottom:"20px !important",marginRight:"5px !important"}),e})),it=n(77),st=function(){var t=Object(f.a)().t;return Object(v.jsxs)("div",{className:ut.description,children:[Object(v.jsx)(u.a,{variant:"h5",children:t("Route Search header")}),Object(v.jsx)(d.a,{}),Object(v.jsx)(u.a,{variant:"subtitle1",children:t("Route Search description")}),Object(v.jsx)("br",{}),Object(v.jsx)(u.a,{variant:"body2",children:t("Route Search constraint")}),Object(v.jsxs)(u.a,{variant:"body2",children:["1. ",t("Route Search caption 1")]}),Object(v.jsxs)(u.a,{variant:"body2",children:["2. ",t("Route Search caption 2")]}),Object(v.jsxs)(u.a,{variant:"body2",children:["3. ",t("Route Search caption 3")]})]})},lt=(e.default=function(){var t=Object(f.a)(),e=t.t,n=t.i18n,a=Object(i.useContext)(j.b),u=a.AppTitle,d=a.geolocation,p=a.energyMode,b=a.db,g=b.routeList,h=b.stopList,O=Object(i.useContext)(m.b),x=O.locations,k=O.setLocations,y=O.status,w=O.setStatus,I=O.result,L=O.setResult,_=O.resultIdx,R=O.setResultIdx,N=Object(i.useRef)(void 0),E=function(){N.current&&(N.current.terminate(),N.current=void 0)};Object(i.useEffect)((function(){Object(Y.f)({title:e("\u9ede\u5c0d\u9ede\u8def\u7dda\u641c\u5c0b")+" - "+e(u),description:e("route-search-page-description"),lang:n.language})}),[n.language]),Object(i.useEffect)((function(){"rendering"===y&&w("ready")}),[I]),Object(i.useEffect)((function(){return"waiting"===y&&x.end&&window.Worker&&(E(),N.current=new Worker("/search-worker.js"),N.current.postMessage({routeList:g,stopList:h,start:x.start?x.start.location:d,end:x.end.location,maxDepth:2}),N.current.onmessage=function(t){if("done"===t.data.type)return E(),void w(t.data.count?"rendering":"ready");!function(t){var e=t.reduce((function(t,e){return t.concat.apply(t,Object(c.a)(e.map((function(t){return["".concat(t.routeId,"/").concat(t.on),"".concat(t.routeId,"/").concat(t.off)]}))))}),[]).filter((function(t,e,n){return n.indexOf(t)===e}));Promise.all(e.map((function(t){var e=t.split("/"),a=Object(r.a)(e,2),c=a[0],i=a[1];return navigator.onLine?Object(it.fetchEtas)(Object(o.a)(Object(o.a)({},g[c]),{},{seq:parseInt(i,10),routeStops:g[c].stops,co:Object.keys(g[c].stops),language:n.language})):new Promise((function(t){return t([])}))}))).then((function(t){return e.filter((function(e,n){return!navigator.onLine||t[n].length&&t[n].reduce((function(t,e){return t||e.eta}),null)}))})).then((function(e){L((function(n){return[].concat(Object(c.a)(n),Object(c.a)(t.filter((function(t){return t.reduce((function(t,n){return t&&(-1!==e.indexOf("".concat(n.routeId,"/").concat(n.on))||-1!==e.indexOf("".concat(n.routeId,"/").concat(n.off)))}),!0)})).map((function(t){var e=x.start?x.start.location:d;return t.map((function(t,n){for(var a=Object.values(g[t.routeId].stops).sort((function(t,e){return e.length-t.length}))[0],r=-1,c=1e5,i=t.on;i<t.off;++i){var s=Object(Y.c)(h[a[i]].location,e);s<c&&(r=i,c=s)}return e=h[a[t.off]].location,Object(o.a)(Object(o.a)({},t),{},{on:r})}))})).map((function(t){return[t,t.reduce((function(t,e){return t+e.off-e.on}),0)]})).sort((function(t,e){return t[1]-e[1]})).map((function(t){return t[0]}))))}))}))}(t.data.value.sort((function(t,e){return t.length-e.length})))}),function(){E()}}),[y,x]);var F=function(t){Object(Y.i)(1),setTimeout((function(){R({resultIdx:t,stopIdx:[0,0]})}),0)};return Object(v.jsxs)(dt,{className:ut.root,square:!0,elevation:0,children:[p?null:Object(v.jsx)(X,{start:x.start?x.start.location:d,end:x.end?x.end.location:null,routes:I[_.resultIdx],stopIdx:_.stopIdx,onMarkerClick:function(t,e){var n=I[_.resultIdx].map((function(t){return t.routeId})).indexOf(t);R((function(t){var a=Object(c.a)(t.stopIdx);return a[n]=e,Object(o.a)(Object(o.a)({},t),{},{stopIdx:a})}))}}),Object(v.jsxs)("div",{className:ut.inputContainer,children:[Object(v.jsx)(C,{value:x.start,placeholder:e("\u4f60\u7684\u4f4d\u7f6e"),onChange:function(t){k(Object(o.a)(Object(o.a)({},x),{},{start:t})),w("waiting"),R({resultIdx:0,stopIdx:[0,0]}),L([])},stopList:h}),Object(v.jsx)(C,{value:x.end,placeholder:e("\u76ee\u7684\u5730"),onChange:function(t){k(Object(o.a)(Object(o.a)({},x),{},{end:t})),t&&w("waiting"),R({resultIdx:0,stopIdx:[0,0]}),L([])},stopList:h})]}),Object(v.jsx)(s.a,{className:p?ut.resultListEnergy:ut.resultList,children:x.end?"waiting|rendering".includes(y)&&0===I.length?Object(v.jsx)(l.a,{size:30,className:ut.routeLoading}):"ready|waiting|rendering".includes(y)&&I.length?I.map((function(t,e){return Object(v.jsx)(S,{routes:t,idx:e,handleRouteClick:F,expanded:e===_.resultIdx,stopIdx:e===_.resultIdx?_.stopIdx:null},"search-result-".concat(e))})):Object(v.jsx)(v.Fragment,{children:e("\u627e\u4e0d\u5230\u5408\u9069\u7684\u5df4\u58eb\u8def\u7dda")}):Object(v.jsx)(st,{})})]})},"search"),ut={root:"".concat(lt,"-root"),inputContainer:"".concat(lt,"-input-container"),description:"".concat(lt,"-description"),resultList:"".concat(lt,"-result-list"),resultListEnergy:"".concat(lt,"-result-list-energy"),routeLoading:"".concat(lt,"-route-loading")},dt=Object(b.a)(p.a)((function(t){var e,n=t.theme;return e={},Object(a.a)(e,"&.".concat(ut.root),{background:"dark"===n.palette.mode?n.palette.background.default:"white",height:"calc(100vh - 125px)",overflowY:"hidden",textAlign:"left"}),Object(a.a)(e,".search-input-container",{marginTop:"2%",padding:"0% 2%"}),Object(a.a)(e,".search-description",{textAlign:"left",marginTop:"5%",padding:"5%"}),Object(a.a)(e,".search-result-list",{overflowY:"scroll",height:"calc(100% - 30vh - 76px)"}),Object(a.a)(e,".search-result-list-energy",{overflowY:"scroll",height:"calc(100% - 76px)"}),Object(a.a)(e,".search-route-loading",{margin:"10%"}),e}))}}]);